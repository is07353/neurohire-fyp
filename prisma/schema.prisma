generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

// Connection URL is in prisma.config.ts (Prisma 7+)
datasource db {
  provider = "postgresql"
}

// ---------------------------------------------------------------------------
// Enums
// ---------------------------------------------------------------------------

enum WorkMode {
  ONSITE
  REMOTE
}

model companies {
  company_id          Int       @id @default(autoincrement())
  company_name        String
  company_description String
  industry            String
  website_url         String?

  contact_email       String    @unique
  contact_person_name String
  contact_phone       String

  // Store a hash here, never the raw password
  password_hash       String

  created_at          DateTime  @default(now())

  // One company can have many recruiters
  recruiters          recruiters[]
}

model admins {
  admin_id      Int          @id @default(autoincrement())
  full_name     String
  email         String       @unique
  password_hash String
  created_at    DateTime     @default(now())
  error_logs    error_logs[]
}

model ai_assessments {
  assessment_id           Int                    @id @default(autoincrement())
  application_id          Int                    @unique

  // CV–JD specific outputs
  cv_score                Int?
  cv_recommendation       String?
  cv_matching_analysis    String?
  cv_reason_summary       String?

  // Full raw JSON output from the CV–JD model
  cv_jd_output            Json?

  candidate_applications  candidate_applications @relation(fields: [application_id], references: [application_id], onDelete: Cascade)

  @@index([application_id])
}

model candidate_applications {
  application_id      Int                  @id @default(autoincrement())
  candidate_id        Int
  job_id              Int
  status              String               @default("pending")
  tag_needs_review    Boolean              @default(false)
  created_at          DateTime             @default(now())
  ai_assessments      ai_assessments?
  candidates          candidates           @relation(fields: [candidate_id], references: [candidate_id], onDelete: Cascade)
  jobs                jobs                 @relation(fields: [job_id], references: [job_id], onDelete: Cascade)
  cv_data             cv_data?
  recruiter_decisions recruiter_decisions?
  // One application can have multiple video submissions (one per job question).
  video_submissions   video_submissions[]  @relation("ApplicationVideoSubmissions")

  @@index([candidate_id, job_id])
}

model candidate_logs {
  log_id       Int        @id @default(autoincrement())
  candidate_id Int
  action       String
  timestamp    DateTime   @default(now())
  candidates   candidates @relation(fields: [candidate_id], references: [candidate_id], onDelete: Cascade)
}

model candidates {
  candidate_id           Int                      @id @default(autoincrement())
  full_name              String?
  email                  String?
  phone                  String?
  created_at             DateTime                 @default(now())
  address                String?
  candidate_applications candidate_applications[]
  candidate_logs         candidate_logs[]
}

// CV file is stored in UploadThing; only metadata is stored here (no binary in DB).
model cv_data {
  cv_id                  Int                    @id @default(autoincrement())
  application_id         Int                    @unique
  cv_text                String
  parsed_keywords        String
  technical_score        Int?
  cv_url                 String?
  cv_file_key            String?
  file_size              Int?
  mime_type              String?
  uploaded_at            DateTime               @default(now())
  candidate_applications candidate_applications @relation(fields: [application_id], references: [application_id], onDelete: Cascade)

  @@index([application_id])
}

model error_logs {
  error_id      Int       @id @default(autoincrement())
  admin_id      Int?
  error_message String
  error_type    String
  status        String    @default("open")
  resolved_at   DateTime?
  created_at    DateTime  @default(now())
  admins        admins?   @relation(fields: [admin_id], references: [admin_id])
}

// Job-specific video interview questions (cascade delete when job is deleted).
// Relation on jobs is named video_questions for clarity.
model job_questions {
  question_id   Int      @id @default(autoincrement())
  job_id        Int
  question_text String
  created_at    DateTime @default(now())
  jobs          jobs     @relation(fields: [job_id], references: [job_id], onDelete: Cascade)
}

model jobs {
  job_id                 Int                      @id @default(autoincrement())
  recruiter_id           Int
  job_title              String
  company_name           String                   @default("")
  branch_name            String                   @default("")
  // Store structured JSON with job_title, skills, other_requirements
  job_description        Json
  created_at             DateTime                 @default(now())
  updated_at             DateTime                 @default(now()) @updatedAt
  status                 String                   @default("open")

  // New job-detail fields (defaults for backward compatibility with existing rows)
  skills                   String[]               @default([]) // multiple skills (PostgreSQL array)
  minimum_experience_years Int                    @default(0)  // must be >= 0 (enforce in app)
  other_requirements       String?
  location                 String                 @default("")
  work_mode                WorkMode              @default(REMOTE)
  salary_monthly_pkr       Int                    @default(0)  // must be > 0 for new jobs (enforce in app)
  // CV and Video weightage are percentage parts that must sum to 100 (e.g. 75% + 25% = 100%). Enforced by DB CHECK and API validation.
  cv_score_weightage       Int                    @default(50)
  video_score_weightage    Int                    @default(50)

  candidate_applications candidate_applications[]
  video_questions       job_questions[]          // job-specific video questions
  recruiters            recruiters               @relation(fields: [recruiter_id], references: [recruiter_id], onDelete: Cascade)

  @@index([recruiter_id])
}

model recruiter_decisions {
  decision_id            Int                    @id @default(autoincrement())
  application_id         Int                    @unique
  recruiter_id           Int
  final_decision         String?
  overrode_ai            Boolean                @default(false)
  comments               String?
  decision_date          DateTime               @default(now())
  candidate_applications candidate_applications @relation(fields: [application_id], references: [application_id], onDelete: Cascade)
  recruiters             recruiters             @relation(fields: [recruiter_id], references: [recruiter_id], onDelete: Cascade)
}

model recruiter_logs {
  log_id       Int        @id @default(autoincrement())
  recruiter_id Int
  action       String
  timestamp    DateTime   @default(now())
  recruiters   recruiters @relation(fields: [recruiter_id], references: [recruiter_id], onDelete: Cascade)
}

model recruiters {
  recruiter_id        Int                   @id @default(autoincrement())

  // Link to the owning company
  company_id          Int?
  companies           companies?            @relation(fields: [company_id], references: [company_id], onDelete: Cascade)

  full_name           String
  email               String                @unique
  password_hash       String
  role                String                @default("recruiter")

  // Optional username and employee ID for login/identification inside a company
  username            String?               @unique
  employee_id         String?               @unique

  // Recruiter account status: 'pending' | 'approved' | 'disabled'
  status              String                @default("pending")

  created_at          DateTime              @default(now())
  jobs                jobs[]
  recruiter_decisions recruiter_decisions[]
  recruiter_logs      recruiter_logs[]
}

model system_settings {
  setting_id    Int      @id @default(autoincrement())
  setting_key   String   @unique
  setting_value String
  updated_at    DateTime
}

// Video file is stored in UploadThing; only metadata is stored here (no binary in DB).
// One application can have multiple video answers (one per question index).
model video_submissions {
  video_id        Int    @id @default(autoincrement())
  application_id  Int
  question_index  Int
  question_text   String
  video_url       String
  video_file_key  String
  file_size       Int?
  mime_type       String?
  created_at      DateTime @default(now())
  audio_transcript String?
  video_score     Int?
  quality_flag    String?

  candidate_applications candidate_applications @relation("ApplicationVideoSubmissions", fields: [application_id], references: [application_id], onDelete: Cascade)

  @@index([application_id])
  @@unique([application_id, question_index])
}